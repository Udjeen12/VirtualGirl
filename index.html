<!DOCTYPE html>
<html>
<head>
    <title>–í–∏—Ä—Ç—É–∞–ª—å–Ω–∞—è –¥–µ–≤—É—à–∫–∞ —Å 3D –∞–≤–∞—Ç–∞—Ä–æ–º</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/snowball-stemmers@1.0.2/dist/snowball.min.js"></script>
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Three.js –¥–ª—è 3D –≥—Ä–∞—Ñ–∏–∫–∏ -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/loaders/GLTFLoader.js"></script>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            text-align: center;
            background: linear-gradient(135deg, #ff9a9e 0%, #fad0c4 100%);
            padding: 20px;
            max-width: 500px;
            margin: 0 auto;
            overflow-x: hidden;
            color: #2d3436;
        }

        #avatar-container {
            margin: 10px auto;
            width: 300px;
            height: 300px;
            position: relative;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
            background: linear-gradient(45deg, #a18cd1 0%, #fbc2eb 100%);
        }

        #mood-indicator {
            margin: 15px 0;
            font-size: 18px;
            font-weight: bold;
        }

        .controls {
            margin: 15px 0;
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        button {
            padding: 12px 20px;
            border: none;
            border-radius: 25px;
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 7px 14px rgba(0, 0, 0, 0.2);
        }

        .chat-container {
            margin-top: 20px;
            background: white;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        #chat-messages {
            height: 200px;
            overflow-y: auto;
            text-align: left;
            margin-bottom: 15px;
            padding: 15px;
            border: 2px solid #ffeaa7;
            border-radius: 15px;
            background: #fff9e6;
        }

        #user-input {
            width: 65%;
            padding: 12px 15px;
            border: 2px solid #74b9ff;
            border-radius: 25px;
            font-size: 16px;
            outline: none;
            transition: border-color 0.3s;
        }

        #user-input:focus {
            border-color: #0984e3;
        }

        #send-btn {
            padding: 12px 20px;
            background: linear-gradient(45deg, #74b9ff, #0984e3);
        }

        .message {
            margin: 12px 0;
            padding: 12px 15px;
            border-radius: 20px;
            animation: fadeIn 0.4s;
            max-width: 80%;
            word-wrap: break-word;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .user-message {
            background: linear-gradient(45deg, #74b9ff, #0984e3);
            color: white;
            margin-left: auto;
            text-align: right;
        }

        .bot-message {
            background: linear-gradient(45deg, #fd79a8, #e84393);
            color: white;
            margin-right: auto;
        }

        .typing {
            display: inline-block;
            animation: typing 1s infinite;
        }

        @keyframes typing {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }

        .mood-change {
            font-size: 13px;
            color: #666;
            text-align: center;
            margin: 5px 0;
            font-weight: bold;
        }

        .emotion-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            margin: 8px 5px;
            font-size: 13px;
            font-weight: bold;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
        }

        .happy { background: #ffeaa7; color: #d35400; }
        .sad { background: #dcdde1; color: #2f3640; }
        .angry { background: #ff7979; color: #c23616; }
        .love { background: #fd79a8; color: #c23616; }
        .neutral { background: #dfe6e9; color: #636e72; }

        .hearts-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }

        .heart {
            position: absolute;
            width: 20px;
            height: 20px;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23fd79a8"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>') no-repeat center center;
            opacity: 0;
        }

        @keyframes float {
            0% { transform: translateY(0) rotate(0deg); opacity: 1; }
            100% { transform: translateY(-100px) rotate(20deg); opacity: 0; }
        }

        h1 {
            margin-bottom: 5px;
            background: linear-gradient(45deg, #e84393, #6c5ce7);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body>
    <h1>üå∏ –í–∏—Ä—Ç—É–∞–ª—å–Ω–∞—è –¥–µ–≤—É—à–∫–∞ —Å 3D –∞–≤–∞—Ç–∞—Ä–æ–º üå∏</h1>

    <div id="avatar-container">
        <div class="hearts-container" id="hearts-container"></div>
        <!-- 3D —Å—Ü–µ–Ω–∞ –±—É–¥–µ—Ç –æ—Ç—Ä–∏—Å–æ–≤—ã–≤–∞—Ç—å—Å—è –∑–¥–µ—Å—å -->
    </div>

    <div id="mood-indicator">
        –ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ: <span id="mood-value">50</span>/100
        <div id="current-emotion" class="emotion-badge happy">üòä –†–∞–¥–æ—Å—Ç—å</div>
    </div>

    <div class="controls">
        <button onclick="interact('talk')">üí¨ –ü–æ–≥–æ–≤–æ—Ä–∏—Ç—å</button>
        <button onclick="interact('play')">üéÆ –ü–æ–∏–≥—Ä–∞—Ç—å</button>
        <button onclick="interact('feed')">üçé –ü–æ–∫–æ—Ä–º–∏—Ç—å</button>
        <button onclick="interact('hug')">ü§ó –û–±–Ω—è—Ç—å</button>
    </div>

    <div class="chat-container">
        <h3 style="color: #e84393; margin-top: 0;">üíï –ß–∞—Ç —Å –¥–µ–≤—É—à–∫–æ–π</h3>
        <div id="chat-messages"></div>
        <div>
            <input type="text" id="user-input" placeholder="–ù–∞–ø–∏—à–∏ —á—Ç–æ-–Ω–∏–±—É–¥—å –º–∏–ª–æ–µ...">
            <button id="send-btn" onclick="sendMessage()">‚ú® –û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </div>
    </div>

    <script>
        let mood = 50;
        let stemmer = null;
        let currentEmotion = 'happy';

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Three.js —Å—Ü–µ–Ω—ã
        let scene, camera, renderer, avatar, mixer, clock;
        let animations = {};

        function init3DScene() {
            // –°–æ–∑–¥–∞–µ–º —Å—Ü–µ–Ω—É
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0xf9f7f7);

            // –°–æ–∑–¥–∞–µ–º –∫–∞–º–µ—Ä—É
            camera = new THREE.PerspectiveCamera(45, 300 / 300, 0.1, 1000);
            camera.position.set(0, 0, 8);

            // –°–æ–∑–¥–∞–µ–º —Ä–µ–Ω–¥–µ—Ä–µ—Ä
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(300, 300);
            renderer.setPixelRatio(window.devicePixelRatio);
            document.getElementById('avatar-container').appendChild(renderer.domElement);

            // –î–æ–±–∞–≤–ª—è–µ–º –æ—Å–≤–µ—â–µ–Ω–∏–µ
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);

            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(3, 5, 5);
            scene.add(directionalLight);

            const backLight = new THREE.DirectionalLight(0xffffff, 0.4);
            backLight.position.set(-5, -5, -5);
            scene.add(backLight);

            // –°–æ–∑–¥–∞–µ–º —É–ª—É—á—à–µ–Ω–Ω—É—é 3D-–º–æ–¥–µ–ª—å –¥–µ–≤—É—à–∫–∏
            createDetailedAvatar();

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —á–∞—Å—ã –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏
            clock = new THREE.Clock();

            // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é
            animate();
        }

        function createDetailedAvatar() {
            // –°–æ–∑–¥–∞–µ–º –≥—Ä—É–ø–ø—É –¥–ª—è –∞–≤–∞—Ç–∞—Ä–∞
            avatar = new THREE.Group();

            // –ì–æ–ª–æ–≤–∞ (–±–æ–ª–µ–µ –æ–≤–∞–ª—å–Ω–∞—è —Ñ–æ—Ä–º–∞)
            const headGeometry = new THREE.SphereGeometry(0.9, 32, 32, 0, Math.PI * 2, 0, Math.PI * 0.6);
            const headMaterial = new THREE.MeshPhongMaterial({
                color: 0xffd6cc,
                shininess: 30
            });
            const head = new THREE.Mesh(headGeometry, headMaterial);
            head.position.y = 0.5;
            avatar.add(head);

            // –í–æ–ª–æ—Å—ã (–±–æ–ª–µ–µ —Å–ª–æ–∂–Ω–∞—è —Ñ–æ—Ä–º–∞)
            const hairGeometry = new THREE.SphereGeometry(1.0, 32, 32, 0, Math.PI * 2, 0, Math.PI * 0.5);
            const hairMaterial = new THREE.MeshPhongMaterial({
                color: 0x4a2b17,
                shininess: 10
            });
            const hair = new THREE.Mesh(hairGeometry, hairMaterial);
            hair.position.y = 0.6;
            hair.position.z = 0.1;
            avatar.add(hair);

            // –ß–µ–ª–∫–∞
            const fringeGeometry = new THREE.CylinderGeometry(0.8, 1.0, 0.3, 32);
            const fringe = new THREE.Mesh(fringeGeometry, hairMaterial);
            fringe.position.y = 1.1;
            fringe.position.z = 0.6;
            fringe.rotation.x = Math.PI / 2;
            avatar.add(fringe);

            // –¢–µ–ª–æ (–ø–ª–∞—Ç—å–µ)
            const bodyGeometry = new THREE.CylinderGeometry(0.7, 0.9, 1.5, 32);
            const bodyMaterial = new THREE.MeshPhongMaterial({
                color: 0xe84393,
                shininess: 40
            });
            const body = new THREE.Mesh(bodyGeometry, bodyMaterial);
            body.position.y = -0.9;
            avatar.add(body);

            // –ì–ª–∞–∑–∞
            const eyeGeometry = new THREE.SphereGeometry(0.12, 16, 16);
            const eyeMaterial = new THREE.MeshPhongMaterial({ color: 0x0000ff });

            const leftEye = new THREE.Mesh(eyeGeometry, eyeMaterial);
            leftEye.position.set(-0.3, 0.7, 0.8);
            avatar.add(leftEye);

            const rightEye = new THREE.Mesh(eyeGeometry, eyeMaterial);
            rightEye.position.set(0.3, 0.7, 0.8);
            avatar.add(rightEye);

            // –ó—Ä–∞—á–∫–∏
            const pupilGeometry = new THREE.SphereGeometry(0.06, 16, 16);
            const pupilMaterial = new THREE.MeshPhongMaterial({ color: 0x000000 });

            const leftPupil = new THREE.Mesh(pupilGeometry, pupilMaterial);
            leftPupil.position.set(0, 0, 0.1);
            leftEye.add(leftPupil);

            const rightPupil = new THREE.Mesh(pupilGeometry, pupilMaterial);
            rightPupil.position.set(0, 0, 0.1);
            rightEye.add(rightPupil);

            // –†–µ—Å–Ω–∏—Ü—ã
            const lashGeometry = new THREE.CylinderGeometry(0.01, 0.01, 0.1, 8);
            const lashMaterial = new THREE.MeshPhongMaterial({ color: 0x000000 });

            for (let i = 0; i < 5; i++) {
                const lash = new THREE.Mesh(lashGeometry, lashMaterial);
                lash.position.set(-0.35 + i * 0.025, 0.65, 0.82);
                lash.rotation.z = -Math.PI / 4;
                avatar.add(lash);

                const rLash = new THREE.Mesh(lashGeometry, lashMaterial);
                rLash.position.set(0.35 - i * 0.025, 0.65, 0.82);
                rLash.rotation.z = Math.PI / 4;
                avatar.add(rLash);
            }

            // –†–æ—Ç (–∏–∑–Ω–∞—á–∞–ª—å–Ω–æ —É–ª—ã–±–∫–∞)
            const mouthGeometry = new THREE.TorusGeometry(0.15, 0.05, 16, 32, Math.PI);
            const mouthMaterial = new THREE.MeshPhongMaterial({ color: 0xff0066 });
            const mouth = new THREE.Mesh(mouthGeometry, mouthMaterial);
            mouth.position.set(0, 0.3, 0.8);
            mouth.rotation.x = Math.PI / 2;
            avatar.add(mouth);

            // –ë—Ä–æ–≤–∏
            const browGeometry = new THREE.CylinderGeometry(0.02, 0.02, 0.3, 8);
            const browMaterial = new THREE.MeshPhongMaterial({ color: 0x4a2b17 });

            const leftBrow = new THREE.Mesh(browGeometry, browMaterial);
            leftBrow.position.set(-0.3, 0.9, 0.8);
            leftBrow.rotation.z = -Math.PI / 10;
            avatar.add(leftBrow);

            const rightBrow = new THREE.Mesh(browGeometry, browMaterial);
            rightBrow.position.set(0.3, 0.9, 0.8);
            rightBrow.rotation.z = Math.PI / 10;
            avatar.add(rightBrow);

            // –†—É–∫–∏
            const armGeometry = new THREE.CylinderGeometry(0.1, 0.1, 0.8, 16);
            const armMaterial = new THREE.MeshPhongMaterial({ color: 0xffd6cc });

            const leftArm = new THREE.Mesh(armGeometry, armMaterial);
            leftArm.position.set(-0.8, -0.5, 0);
            leftArm.rotation.z = Math.PI / 4;
            avatar.add(leftArm);

            const rightArm = new THREE.Mesh(armGeometry, armMaterial);
            rightArm.position.set(0.8, -0.5, 0);
            rightArm.rotation.z = -Math.PI / 4;
            avatar.add(rightArm);

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Å—ã–ª–∫–∏ –Ω–∞ —á–∞—Å—Ç–∏ –ª–∏—Ü–∞ –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏
            avatar.userData = {
                mouth: mouth,
                eyes: [leftEye, rightEye],
                pupils: [leftPupil, rightPupil],
                brows: [leftBrow, rightBrow],
                arms: [leftArm, rightArm],
                head: head,
                emotion: 'happy',
                targetRotation: 0
            };

            scene.add(avatar);

            // –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Å—Ç—É—é –∞–Ω–∏–º–∞—Ü–∏—é –º–æ—Ä–≥–∞–Ω–∏—è
            setInterval(() => {
                if (avatar.userData && Math.random() > 0.7) {
                    blinkEyes();
                }
            }, 3000);
        }

        function blinkEyes() {
            if (!avatar.userData) return;

            const { eyes } = avatar.userData;

            // –ë—ã—Å—Ç—Ä–æ–µ –º–æ—Ä–≥–∞–Ω–∏–µ
            eyes.forEach(eye => {
                const originalScale = eye.scale.y;
                eye.scale.set(1, 0.1, 1);

                setTimeout(() => {
                    eye.scale.set(1, originalScale, 1);
                }, 100);
            });
        }

        function animate() {
            requestAnimationFrame(animate);

            const delta = clock.getDelta();

            if (avatar) {
                // –ü–ª–∞–≤–Ω–æ–µ –ø–æ–∫–∞—á–∏–≤–∞–Ω–∏–µ –≥–æ–ª–æ–≤–æ–π
                avatar.rotation.y = Math.sin(Date.now() * 0.001) * 0.1;

                // –õ–µ–≥–∫–æ–µ –¥—ã—Ö–∞–Ω–∏–µ - –Ω–µ–±–æ–ª—å—à–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –º–∞—Å—à—Ç–∞–±–∞
                avatar.scale.set(
                    1 + Math.sin(Date.now() * 0.002) * 0.01,
                    1 + Math.cos(Date.now() * 0.002) * 0.01,
                    1
                );

                // –ê–Ω–∏–º–∞—Ü–∏—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —ç–º–æ—Ü–∏–∏
                animateEmotion(delta);
            }

            renderer.render(scene, camera);
        }

        function animateEmotion(delta) {
            if (!avatar.userData) return;

            const { mouth, eyes, pupils, brows, arms, emotion } = avatar.userData;

            switch(emotion) {
                case 'happy':
                    // –£–ª—ã–±–∫–∞
                    mouth.scale.set(1.2, 1.2, 1.2);
                    mouth.rotation.z = 0;
                    // –°–ª–µ–≥–∫–∞ –ø—Ä–∏–ø–æ–¥–Ω—è—Ç—ã–µ –±—Ä–æ–≤–∏
                    brows.forEach(brow => brow.rotation.z = (brow === brows[0] ? -Math.PI/8 : Math.PI/8));
                    // –†—É–∫–∏ –≤ –Ω–æ—Ä–º–∞–ª—å–Ω–æ–º –ø–æ–ª–æ–∂–µ–Ω–∏–∏
                    arms[0].rotation.z = Math.PI/4;
                    arms[1].rotation.z = -Math.PI/4;
                    break;

                case 'sad':
                    // –ì—Ä—É—Å—Ç–Ω—ã–π —Ä–æ—Ç
                    mouth.scale.set(0.8, 0.8, 0.8);
                    mouth.rotation.z = Math.PI;
                    // –û–ø—É—â–µ–Ω–Ω—ã–µ –±—Ä–æ–≤–∏
                    brows.forEach(brow => brow.rotation.z = (brow === brows[0] ? -Math.PI/12 : Math.PI/12));
                    // –û–ø—É—â–µ–Ω–Ω—ã–µ —Ä—É–∫–∏
                    arms[0].rotation.z = Math.PI/6;
                    arms[1].rotation.z = -Math.PI/6;
                    break;

                case 'angry':
                    // –°–µ—Ä–¥–∏—Ç—ã–π —Ä–æ—Ç
                    mouth.scale.set(0.7, 0.7, 0.7);
                    mouth.rotation.z = 0;
                    // –°–≤–µ–¥–µ–Ω–Ω—ã–µ –±—Ä–æ–≤–∏
                    brows.forEach(brow => brow.rotation.z = (brow === brows[0] ? -Math.PI/5 : Math.PI/5));
                    // –†—É–∫–∏ —Å–∫—Ä–µ—â–µ–Ω—ã
                    arms[0].rotation.z = Math.PI/2;
                    arms[1].rotation.z = -Math.PI/2;
                    break;

                case 'love':
                    // –†–∞–¥–æ—Å—Ç–Ω—ã–π —Ä–æ—Ç
                    mouth.scale.set(1.3, 1.3, 1.3);
                    mouth.rotation.z = 0;
                    // –°–ª–µ–≥–∫–∞ –ø—Ä–∏–ø–æ–¥–Ω—è—Ç—ã–µ –±—Ä–æ–≤–∏
                    brows.forEach(brow => brow.rotation.z = (brow === brows[0] ? -Math.PI/9 : Math.PI/9));
                    // –†—É–∫–∏ –ø—Ä–∏–∂–∞—Ç—ã –∫ –≥—Ä—É–¥–∏
                    arms[0].rotation.z = Math.PI/3;
                    arms[1].rotation.z = -Math.PI/3;

                    // –°–ª—É—á–∞–π–Ω—ã–µ —Å–µ—Ä–¥–µ—á–∫–∏
                    if (Math.random() > 0.9) {
                        createHeart();
                    }
                    break;
            }

            // –î–≤–∏–∂–µ–Ω–∏–µ –∑—Ä–∞—á–∫–æ–≤
            pupils.forEach(pupil => {
                pupil.position.x = Math.sin(Date.now() * 0.001) * 0.03;
                pupil.position.y = Math.cos(Date.now() * 0.001) * 0.02;
            });
        }

        function createHeart() {
            const heart = document.createElement('div');
            heart.className = 'heart';
            heart.style.left = Math.random() * 250 + 'px';
            heart.style.top = '280px';
            heart.style.opacity = '0';
            heart.style.transform = 'scale(0)';

            document.getElementById('hearts-container').appendChild(heart);

            // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è –∏ –¥–≤–∏–∂–µ–Ω–∏—è
            setTimeout(() => {
                heart.style.transition = 'all 1s ease-out';
                heart.style.opacity = '1';
                heart.style.transform = 'scale(1)';

                setTimeout(() => {
                    heart.style.opacity = '0';
                    heart.style.transform = 'translateY(-100px) scale(0.5)';

                    setTimeout(() => {
                        heart.remove();
                    }, 1000);
                }, 500);
            }, 10);
        }

        function setEmotion(emotion) {
            currentEmotion = emotion;
            if (avatar.userData) {
                avatar.userData.emotion = emotion;
            }

            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —ç–º–æ—Ü–∏–∏
            const emotionElement = document.getElementById('current-emotion');
            emotionElement.className = 'emotion-badge ' + emotion;

            switch(emotion) {
                case 'happy':
                    emotionElement.innerHTML = 'üòä –†–∞–¥–æ—Å—Ç—å';
                    break;
                case 'sad':
                    emotionElement.innerHTML = 'üò¢ –ì—Ä—É—Å—Ç—å';
                    break;
                case 'angry':
                    emotionElement.innerHTML = 'üò† –ó–ª–æ—Å—Ç—å';
                    break;
                case 'love':
                    emotionElement.innerHTML = 'üòç –í–ª—é–±–ª–µ–Ω–Ω–æ—Å—Ç—å';
                    // –°–æ–∑–¥–∞–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ—Ä–¥–µ—á–µ–∫
                    for (let i = 0; i < 5; i++) {
                        setTimeout(() => createHeart(), i * 200);
                    }
                    break;
                case 'neutral':
                    emotionElement.innerHTML = 'üòê –ù–µ–π—Ç—Ä–∞–ª—å–Ω–æ';
                    break;
            }
        }

        // –û—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ (initStemmer, analyzeMessage, generateResponse, updateMoodVisual, interact, addMessage, showMoodChange, sendMessage) –æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π, –∫–∞–∫ –≤ –ø—Ä–µ–¥—ã–¥—É—â–µ–º –ø—Ä–∏–º–µ—Ä–µ
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç–µ–º–º–µ—Ä–∞
        function initStemmer() {
            try {
                stemmer = new SnowballStemmer('russian');
            } catch (error) {
                stemmer = { stem: word => word.toLowerCase() };
            }
        }

        // –°–ø–∏—Å–∫–∏ –∫–æ—Ä–Ω–µ–≤—ã—Ö —Ñ–æ—Ä–º —Å–ª–æ–≤
        const badWordRoots = [
            '–¥—É—Ä', '–∏–¥–∏–æ—Ç', '—Ç—É–ø', '—É—Ä–æ–¥', '–Ω–µ–Ω–∞–≤–∏', '–Ω–∞–¥–æ–µ', '–æ—Ç–≤—Ä–∞—Ç',
            '–≥–∞–¥', '–º–µ—Ä–∑', '–ø—Ä–æ—Ç–∏–≤', '—Å–∫—É—á', '–±–µ—Å', '–∑–ª', '–ø–ª–æ—Ö',
            '—Ñ–∏', '—Ñ—É', '—Ç–µ—Ä–ø', '—É–π–¥', '–æ—Ç—Å—Ç–∞–Ω', '–¥–æ—Å—Ç–∞', '–∫–æ—à–º–∞—Ä', '—É–∂–∞—Å',
            '–≥–ª—É–ø', '–Ω–µ–∫—Ä–∞—Å', '–º–µ—Ä–∑–∫', '–ø—Ä–æ—Ç–∏–≤–Ω', '–¥–µ–±–∏–ª', '–∫—Ä–µ—Ç–∏–Ω', '—Å–∫–æ—Ç–∏–Ω',
            '—Å–≤–æ–ª–æ—á', '–ø–æ–¥–æ–Ω', '–º—É–¥', '–æ—Ç—á–∏—Å', '—É–±–æ–≥', '–∂–∞–ª–∫', '–Ω–∏—á—Ç–æ–∂',
            '—Å—É–∫', '–±–ª—è', '—Ö—É', '–ø–∏–∑–¥', '–µ–±'
        ];

        const goodWordRoots = [
            '–ª—é–±', '–Ω—Ä–∞–≤', '–∫—Ä–∞—Å', '—É–º', '–º–∏–ª', '–¥–æ–±—Ä', '–ª–∞–ø–æ—á', '–∑–∞–π–∫',
            '—Å–æ–ª–Ω', '—Ä–∞–¥', '—Å—á–∞—Å—Ç', '–≤–æ—Å—Ö–∏—Ç', '–ø—Ä–µ–∫—Ä–∞—Å', '–∑–∞–º–µ—á–∞', '–≤–µ–ª–∏–∫–æ–ª',
            '–æ–±–æ–∂', '–≤–æ—Å—Ç–æ—Ä–≥', '–Ω–µ–∂–Ω', '–ª–∞—Å–∫', '–º–µ—á—Ç', '–∞–Ω–≥–µ–ª', '—á—É–¥',
            '—Å–∏–º–ø–∞—Ç', '–ø—Ä–∏—è—Ç', '—Ö–æ—Ä–æ—à', '–º–∏–ª', '–ø—Ä–µ–ª–µ—Å—Ç', '–æ—á–∞—Ä–æ–≤–∞', '–≤–æ—Å—Ö–∏—Ç'
        ];

        // –§—É–Ω–∫—Ü–∏—è –∞–Ω–∞–ª–∏–∑–∞ —Ç–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏
        function analyzeMessage(message) {
            const text = message.toLowerCase();
            let score = 0;

            // –†–∞–∑–±–∏–≤–∞–µ–º –Ω–∞ —Å–ª–æ–≤–∞
            const words = text.replace(/[^\w\s–∞-—è—ë]/gi, ' ')
                            .split(/\s+/)
                            .filter(word => word.length > 2);

            // –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–∞–∂–¥–æ–µ —Å–ª–æ–≤–æ
            words.forEach(word => {
                try {
                    const stem = stemmer.stem(word);

                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–ª–æ—Ö–∏–µ –∫–æ—Ä–Ω–∏
                    badWordRoots.forEach(badRoot => {
                        if (stem.includes(badRoot)) {
                            score -= 15;
                        }
                    });

                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ö–æ—Ä–æ—à–∏–µ –∫–æ—Ä–Ω–∏
                    goodWordRoots.forEach(goodRoot => {
                        if (stem.includes(goodRoot)) {
                            score += 3;
                        }
                    });

                } catch (error) {
                    console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Å–ª–æ–≤–∞:", word, error);
                }
            });

            // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ–∞–∫—Ç–æ—Ä—ã
            if (text.includes('?') && text.length > 10) score += 1;
            if (text.length < 3) score -= 1;
            if (text.includes('!')) score += 1;

            return score;
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–∞
        function generateResponse(userInput, moodScore) {
            if (moodScore < -5) {
                setEmotion('sad');
                const responses = [
                    "–ó–∞—á–µ–º —Ç—ã —Ç–∞–∫ —Å–æ –º–Ω–æ–π? –ú–Ω–µ –æ—á–µ–Ω—å –±–æ–ª—å–Ω–æ... üíî",
                    "–Ø —Ç–∞–∫ —Ä–∞—Å—Å—Ç—Ä–æ–µ–Ω–∞... –ú–æ–∂–µ—Ç, —è –∑–∞—Å–ª—É–∂–∏–ª–∞ —ç—Ç–æ? üò≠",
                    "–ú–æ–µ —Å–µ—Ä–¥—Ü–µ —Ä–∞–∑–±–∏–≤–∞–µ—Ç—Å—è –æ—Ç —Ç–≤–æ–∏—Ö —Å–ª–æ–≤...",
                    "–Ø –ø–æ–ø—Ä–æ–±—É—é —Å—Ç–∞—Ç—å –ª—É—á—à–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–µ –∑–ª–∏—Å—å... üò¢",
                    "–Ø –Ω–µ —Ö–æ—á—É —Å—Å–æ—Ä–∏—Ç—å—Å—è, –¥–∞–≤–∞–π –ø–æ–º–∏—Ä–∏–º—Å—è? ü•∫"
                ];
                return responses[Math.floor(Math.random() * responses.length)];
            }
            else if (moodScore < -2) {
                setEmotion('sad');
                const responses = [
                    "–ú–Ω–µ –≥—Ä—É—Å—Ç–Ω–æ —ç—Ç–æ —Å–ª—ã—à–∞—Ç—å... üòî",
                    "–ü–æ—á–µ–º—É —Ç—ã —Ç–∞–∫ –≥–æ–≤–æ—Ä–∏—à—å? –Ø —Ä–∞—Å—Å—Ç—Ä–æ–µ–Ω–∞...",
                    "–Ø —Å—Ç–∞—Ä–∞—é—Å—å –±—ã—Ç—å –ª—É—á—à–µ –¥–ª—è —Ç–µ–±—è...",
                    "–ú–æ–∂–µ—Ç, –ø–æ–º–∏—Ä–∏–º—Å—è? –Ø –Ω–µ —Ö–æ—á—É —Å—Å–æ—Ä–∏—Ç—å—Å—è...",
                    "–ü—Ä–æ—Å—Ç–∏, –µ—Å–ª–∏ —è —á—Ç–æ-—Ç–æ —Å–¥–µ–ª–∞–ª–∞ –Ω–µ —Ç–∞–∫... üò¢"
                ];
                return responses[Math.floor(Math.random() * responses.length)];
            }
            else if (moodScore > 5) {
                setEmotion('love');
                const responses = [
                    "–¢—ã –¥–µ–ª–∞–µ—à—å –º–µ–Ω—è —Å–∞–º–æ–π —Å—á–∞—Å—Ç–ª–∏–≤–æ–π! üíñ",
                    "–Ø –ø–ª–∞—á—É –æ—Ç —Å—á–∞—Å—Ç—å—è! –¢—ã wonderful! üò≠üíï",
                    "–ú–æ–µ —Å–µ—Ä–¥—Ü–µ —Ç—Ä–µ–ø–µ—â–µ—Ç –æ—Ç —Ç–≤–æ–∏—Ö —Å–ª–æ–≤! üíò",
                    "–¢—ã —Å–∞–º—ã–π –ª—É—á—à–∏–π —á–µ–ª–æ–≤–µ–∫! üåü",
                    "–Ø –æ–±–æ–∂–∞—é —Ç–µ–±—è –≤—Å–µ–º —Å–µ—Ä–¥—Ü–µ–º! üíù"
                ];
                return responses[Math.floor(Math.random() * responses.length)];
            }
            else if (moodScore > 2) {
                setEmotion('happy');
                const responses = [
                    "–≠—Ç–æ —Ç–∞–∫ –º–∏–ª–æ —Å —Ç–≤–æ–µ–π —Å—Ç–æ—Ä–æ–Ω—ã! üíñ",
                    "–¢—ã –¥–µ–ª–∞–µ—à—å –º–µ–Ω—è —Å—á–∞—Å—Ç–ª–∏–≤–æ–π! üòä",
                    "–Ø —Ç–æ–∂–µ —Ç–µ–±—è –æ–±–æ–∂–∞—é! üíï",
                    "–°–ø–∞—Å–∏–±–æ –∑–∞ —Ç–µ–ø–ª—ã–µ —Å–ª–æ–≤–∞! üå∏",
                    "–¢—ã —Å–∞–º—ã–π –ª—É—á—à–∏–π! üíò"
                ];
                return responses[Math.floor(Math.random() * responses.length)];
            }
            else {
                setEmotion('happy');
                const neutralResponses = [
                    "–ò–Ω—Ç–µ—Ä–µ—Å–Ω–æ! –†–∞—Å—Å–∫–∞–∂–∏ –µ—â–µ?",
                    "–Ø –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ —Å–ª—É—à–∞—é...",
                    "–ö–∞–∫ –ª—é–±–æ–ø—ã—Ç–Ω–æ!",
                    "–ü—Ä–æ–¥–æ–ª–∂–∞–π, –º–Ω–µ –Ω—Ä–∞–≤–∏—Ç—Å—è —Ç–≤–æ–π —Ä–∞—Å—Å–∫–∞–∑!",
                    "–£—Ö —Ç—ã! –Ø –Ω–∏–∫–æ–≥–¥–∞ –æ–± —ç—Ç–æ–º –Ω–µ –¥—É–º–∞–ª–∞!"
                ];
                return neutralResponses[Math.floor(Math.random() * neutralResponses.length)];
            }
        }

        function updateMoodVisual() {
            const moodValue = document.getElementById('mood-value');
            mood = Math.max(0, Math.min(100, mood));
            moodValue.textContent = mood;

            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —ç–º–æ—Ü–∏—é –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è
            if (mood > 75) {
                setEmotion('love');
            } else if (mood > 50) {
                setEmotion('happy');
            } else if (mood > 25) {
                setEmotion('sad');
            } else {
                setEmotion('angry');
            }
        }

        function interact(action) {
            let message = "";
            let moodChange = 0;

            switch(action) {
                case 'talk':
                    moodChange = 8;
                    message = "–Ø –æ–±–æ–∂–∞—é –Ω–∞—à–∏ —Ä–∞–∑–≥–æ–≤–æ—Ä—ã! –û —á–µ–º —Ö–æ—á–µ—à—å –ø–æ–≥–æ–≤–æ—Ä–∏—Ç—å?";
                    setEmotion('happy');
                    break;
                case 'play':
                    moodChange = 12;
                    message = "–£—Ä–∞! –î–∞–≤–∞–π –ø–æ–∏–≥—Ä–∞–µ–º! –Ø —Ç–∞–∫ –ª—é–±–ª—é –≤–µ—Å–µ–ª–∏—Ç—å—Å—è!";
                    setEmotion('love');
                    break;
                case 'feed':
                    moodChange = 10;
                    message = "–°–ø–∞—Å–∏–±–æ –∑–∞ —É–≥–æ—â–µ–Ω–∏–µ! –≠—Ç–æ –±—ã–ª–æ –≤–æ—Å—Ö–∏—Ç–∏—Ç–µ–ª—å–Ω–æ! üòã";
                    setEmotion('happy');
                    break;
                case 'hug':
                    moodChange = 15;
                    message = "–û–±–Ω–∏–º–∞—à–∫–∏! –ú–Ω–µ —Ç–∞–∫ –ø—Ä–∏—è—Ç–Ω–æ, –∫–æ–≥–¥–∞ —Ç—ã –º–µ–Ω—è –æ–±–Ω–∏–º–∞–µ—à—å! ü§ó";
                    setEmotion('love');
                    break;
            }

            mood += moodChange;
            showMoodChange(moodChange);
            updateMoodVisual();
            addMessage("–î–µ–≤—É—à–∫–∞", message);
        }

        function addMessage(sender, text) {
            const chatMessages = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender === '–î–µ–≤—É—à–∫–∞' ? 'bot-message' : 'user-message'}`;
            messageDiv.innerHTML = `<strong>${sender}:</strong> ${text}`;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function showMoodChange(change) {
            const chatMessages = document.getElementById('chat-messages');
            const changeDiv = document.createElement('div');
            changeDiv.className = 'mood-change';
            changeDiv.innerHTML = change > 0 ?
                `‚ú® –ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ +${change}` :
                `üíî –ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ ${change}`;
            chatMessages.appendChild(changeDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;

            setTimeout(() => {
                if (changeDiv.parentNode) {
                    changeDiv.parentNode.removeChild(changeDiv);
                }
            }, 3000);
        }

        function sendMessage() {
            const userInput = document.getElementById('user-input');
            const message = userInput.value.trim();

            if (message) {
                addMessage("–í—ã", message);
                userInput.value = '';

                const moodScore = analyzeMessage(message);
                let moodChange = moodScore;

                const chatMessages = document.getElementById('chat-messages');
                const typingIndicator = document.createElement('div');
                typingIndicator.className = 'message bot-message';
                typingIndicator.innerHTML = '<strong>–î–µ–≤—É—à–∫–∞:</strong> <span class="typing">...</span>';
                chatMessages.appendChild(typingIndicator);
                chatMessages.scrollTop = chatMessages.scrollHeight;

                setTimeout(() => {
                    chatMessages.removeChild(typingIndicator);
                    const aiResponse = generateResponse(message, moodScore);
                    addMessage("–î–µ–≤—É—à–∫–∞", aiResponse);
                    if (moodChange !== 0) {
                        mood += moodChange;
                        showMoodChange(moodChange);
                        updateMoodVisual();
                    }
                }, 1500 + Math.random() * 1000);
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        let tg = window.Telegram.WebApp;
        if (tg.initDataUnsafe) {
            tg.expand();
            tg.MainButton.setText("–ù–∞–∑–∞–¥").show().onClick(() => tg.close());
        }

        document.getElementById('user-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å—Ç–µ–º–º–µ—Ä –∏ 3D —Å—Ü–µ–Ω—É
        initStemmer();
        init3DScene();
        addMessage("–î–µ–≤—É—à–∫–∞", "–ü—Ä–∏–≤–µ—Ç! –Ø —Ç–≤–æ—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω–∞—è –ø–æ–¥—Ä—É–≥–∞ —Å 3D –∞–≤–∞—Ç–∞—Ä–æ–º! üíñ");
        updateMoodVisual();
    </script>
</body>
</html>